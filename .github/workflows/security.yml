name: Security Scanning

on:
  schedule:
    # Run every Sunday at 2:00 AM UTC
    - cron: '0 2 * * 0'
  push:
    branches: [main, develop]
    paths:
      - '**/package.json'
      - '**/package-lock.json'
  pull_request:
    branches: [main]
    paths:
      - '**/package.json'
      - '**/package-lock.json'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  dependency-audit:
    name: Dependency Vulnerability Audit
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: root
            path: .
          - name: backend
            path: backend
          - name: admin-ui
            path: admin-ui
          - name: frontend
            path: frontend/nexus-app
          - name: landing
            path: landing

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check if package.json exists
        id: check
        run: |
          if [ -f "${{ matrix.path }}/package.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        if: steps.check.outputs.exists == 'true'
        working-directory: ${{ matrix.path }}
        run: npm ci --ignore-scripts
        continue-on-error: true

      - name: Run npm audit
        if: steps.check.outputs.exists == 'true'
        working-directory: ${{ matrix.path }}
        run: |
          echo "## npm audit results for ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          npm audit --json > audit-results.json 2>&1 || true

          # Parse and display results
          VULNERABILITIES=$(jq '.metadata.vulnerabilities' audit-results.json 2>/dev/null || echo "{}")
          CRITICAL=$(echo $VULNERABILITIES | jq '.critical // 0')
          HIGH=$(echo $VULNERABILITIES | jq '.high // 0')
          MODERATE=$(echo $VULNERABILITIES | jq '.moderate // 0')
          LOW=$(echo $VULNERABILITIES | jq '.low // 0')

          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| Moderate | $MODERATE |" >> $GITHUB_STEP_SUMMARY
          echo "| Low | $LOW |" >> $GITHUB_STEP_SUMMARY

          # Fail on critical or high vulnerabilities
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "::error::Found $CRITICAL critical and $HIGH high severity vulnerabilities in ${{ matrix.name }}"
            npm audit --audit-level=high
            exit 1
          fi

          echo "No critical or high vulnerabilities found in ${{ matrix.name }}"

      - name: Upload audit results
        if: steps.check.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: audit-${{ matrix.name }}
          path: ${{ matrix.path }}/audit-results.json
          retention-days: 30

  secret-scanning:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install TruffleHog
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

      - name: Run TruffleHog scan
        run: |
          echo "## Secret Scanning Results" >> $GITHUB_STEP_SUMMARY

          # Scan for secrets
          trufflehog git file://. --only-verified --json 2>/dev/null | tee secrets-scan.json || true

          # Check if any secrets were found
          if [ -s secrets-scan.json ]; then
            SECRETS_COUNT=$(wc -l < secrets-scan.json)
            if [ "$SECRETS_COUNT" -gt 0 ]; then
              echo "::error::Found $SECRETS_COUNT potential secrets in the codebase!"
              echo "Found $SECRETS_COUNT potential secrets" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi

          echo "No verified secrets found" >> $GITHUB_STEP_SUMMARY

      - name: Check for common secret patterns
        run: |
          echo "Checking for common secret patterns..."

          # Define patterns to check (excluding test files and examples)
          PATTERNS=(
            "api[_-]?key\s*[:=]\s*['\"][a-zA-Z0-9]+"
            "secret[_-]?key\s*[:=]\s*['\"][a-zA-Z0-9]+"
            "password\s*[:=]\s*['\"][^'\"]{8,}"
            "AWS_SECRET_ACCESS_KEY"
            "STRIPE_SECRET_KEY\s*=\s*sk_live"
            "-----BEGIN (RSA |EC )?PRIVATE KEY-----"
          )

          FOUND_SECRETS=0

          for pattern in "${PATTERNS[@]}"; do
            # Search but exclude common false positive directories
            MATCHES=$(grep -rniE "$pattern" . \
              --exclude-dir=node_modules \
              --exclude-dir=.git \
              --exclude-dir=dist \
              --exclude-dir=build \
              --exclude="*.md" \
              --exclude="*.example" \
              --exclude=".env.example" \
              --exclude="*.test.*" \
              --exclude="*.spec.*" \
              2>/dev/null || true)

            if [ -n "$MATCHES" ]; then
              echo "::warning::Potential secret pattern found: $pattern"
              echo "$MATCHES" | head -5
              FOUND_SECRETS=1
            fi
          done

          if [ "$FOUND_SECRETS" -eq 1 ]; then
            echo "::warning::Review the above matches for potential secrets"
          else
            echo "No common secret patterns detected"
          fi

  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

  license-check:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install license-checker
        run: npm install -g license-checker

      - name: Check licenses (root)
        run: |
          npm ci --ignore-scripts
          echo "## License Check - Root" >> $GITHUB_STEP_SUMMARY
          license-checker --summary >> $GITHUB_STEP_SUMMARY || true

          # Check for problematic licenses
          PROBLEMATIC=$(license-checker --json | jq -r 'to_entries[] | select(.value.licenses | test("GPL|AGPL|SSPL"; "i")) | .key' || true)
          if [ -n "$PROBLEMATIC" ]; then
            echo "::warning::Found packages with potentially restrictive licenses:"
            echo "$PROBLEMATIC"
          fi

      - name: Check licenses (backend)
        working-directory: backend
        run: |
          npm ci --ignore-scripts
          echo "## License Check - Backend" >> $GITHUB_STEP_SUMMARY
          license-checker --summary >> $GITHUB_STEP_SUMMARY || true

  security-headers-check:
    name: Security Headers Check
    runs-on: ubuntu-latest
    # Only run on schedule or manual trigger (not on every push)
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Check security headers (if production is available)
        run: |
          echo "## Security Headers Analysis" >> $GITHUB_STEP_SUMMARY

          # Check production backend (if available)
          BACKEND_URL="https://nexus-backend.onrender.com"

          echo "Checking $BACKEND_URL..."
          HEADERS=$(curl -sI $BACKEND_URL 2>/dev/null || echo "")

          if [ -z "$HEADERS" ]; then
            echo "Could not reach $BACKEND_URL" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Check for important security headers
          check_header() {
            HEADER_NAME=$1
            if echo "$HEADERS" | grep -qi "^$HEADER_NAME:"; then
              echo "- $HEADER_NAME: Present" >> $GITHUB_STEP_SUMMARY
            else
              echo "- $HEADER_NAME: **Missing**" >> $GITHUB_STEP_SUMMARY
              echo "::warning::Missing security header: $HEADER_NAME"
            fi
          }

          echo "### Security Headers" >> $GITHUB_STEP_SUMMARY
          check_header "X-Content-Type-Options"
          check_header "X-Frame-Options"
          check_header "X-XSS-Protection"
          check_header "Strict-Transport-Security"
          check_header "Content-Security-Policy"

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-audit, secret-scanning, codeql-analysis, license-check]
    if: always()
    steps:
      - name: Generate security summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | ${{ needs.secret-scanning.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | ${{ needs.codeql-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Scan completed at: $(date -u)" >> $GITHUB_STEP_SUMMARY

      - name: Fail if critical issues found
        run: |
          if [[ "${{ needs.dependency-audit.result }}" == "failure" ]] || \
             [[ "${{ needs.secret-scanning.result }}" == "failure" ]]; then
            echo "::error::Critical security issues were found. Please review and fix."
            exit 1
          fi
