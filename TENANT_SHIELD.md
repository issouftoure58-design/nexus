# âš ï¸ TENANT SHIELD - PROTECTION ABSOLUE âš ï¸

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                               â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                      â•‘
â•‘   â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•                      â•‘
â•‘      â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘                         â•‘
â•‘      â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘                         â•‘
â•‘      â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘                         â•‘
â•‘      â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•   â•šâ•â•                         â•‘
â•‘                                                                               â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—                                  â•‘
â•‘   â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—                                 â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘                                 â•‘
â•‘   â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘                                 â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•                                 â•‘
â•‘   â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•                                  â•‘
â•‘                                                                               â•‘
â•‘                    ğŸ›¡ï¸ PROTECTION MULTI-TENANT ğŸ›¡ï¸                              â•‘
â•‘                                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## ğŸš¨ RÃˆGLE NÂ°1 - LA LOI ABSOLUE

> **CHAQUE requÃªte base de donnÃ©es DOIT filtrer par `tenant_id`**
>
> **AUCUNE EXCEPTION. JAMAIS. POINT FINAL.**

---

## ğŸ”´ AVANT DE CODER - LIS CECI

### Tu touches Ã  une requÃªte Supabase ?

```javascript
// âŒ INTERDIT - BLOQUÃ‰ PAR LE SYSTÃˆME
const { data } = await supabase
  .from('reservations')
  .select('*');

// âœ… OBLIGATOIRE - LA SEULE FAÃ‡ON
const { data } = await supabase
  .from('reservations')
  .select('*')
  .eq('tenant_id', tenantId);  // ğŸ›¡ï¸ TENANT SHIELD
```

### Tu crÃ©es une nouvelle route API ?

```javascript
// âŒ INTERDIT - JAMAIS SANS TENANT
router.get('/data', async (req, res) => {
  const data = await getData(); // D'OÃ™ VIENT LE TENANT ?!
});

// âœ… OBLIGATOIRE - TOUJOURS AVEC TENANT
router.get('/data', async (req, res) => {
  const tenantId = req.tenantId; // ğŸ›¡ï¸ VIENT DU MIDDLEWARE
  if (!tenantId) throw new Error('TENANT_REQUIRED');
  const data = await getData(tenantId);
});
```

---

## ğŸ›¡ï¸ LES 5 COMMANDEMENTS DU TENANT SHIELD

### 1ï¸âƒ£ TOUTE requÃªte SELECT filtre par tenant_id
```javascript
.eq('tenant_id', tenantId)  // OBLIGATOIRE
```

### 2ï¸âƒ£ TOUTE requÃªte INSERT inclut tenant_id
```javascript
.insert({ ...data, tenant_id: tenantId })  // OBLIGATOIRE
```

### 3ï¸âƒ£ TOUTE requÃªte UPDATE/DELETE filtre par tenant_id
```javascript
.update(data).eq('tenant_id', tenantId)  // OBLIGATOIRE
.delete().eq('tenant_id', tenantId)      // OBLIGATOIRE
```

### 4ï¸âƒ£ TOUTE fonction reÃ§oit tenantId en paramÃ¨tre
```javascript
async function maFonction(tenantId, ...autres) {  // tenantId EN PREMIER
  if (!tenantId) throw new Error('TENANT_SHIELD: tenant_id requis');
}
```

### 5ï¸âƒ£ JAMAIS de fallback sur un tenant par dÃ©faut
```javascript
// âŒ INTERDIT
const tenantId = req.tenantId || 'fatshairafro';

// âœ… OBLIGATOIRE
const tenantId = req.tenantId;
if (!tenantId) throw new TenantRequiredError();
```

---

## ğŸš¦ TABLES SYSTÃˆME vs TABLES TENANT

### Tables SYSTÃˆME (pas de tenant_id)
```
tenants          - Configuration des tenants
tenant_phone_numbers - Mapping tÃ©lÃ©phone â†’ tenant
plans            - Plans tarifaires
```

### Tables TENANT (tenant_id OBLIGATOIRE)
```
reservations     â† TOUJOURS filtrer par tenant_id
clients          â† TOUJOURS filtrer par tenant_id
services         â† TOUJOURS filtrer par tenant_id
conversations    â† TOUJOURS filtrer par tenant_id
... TOUTES LES AUTRES
```

---

## ğŸ”’ CHECKLIST AVANT COMMIT

```
â–¡ Chaque .from('table') a un .eq('tenant_id', tenantId) ?
â–¡ Chaque INSERT inclut tenant_id ?
â–¡ Chaque fonction a tenantId en paramÃ¨tre ?
â–¡ Pas de fallback tenant par dÃ©faut ?
â–¡ Les tests tenant isolation passent ?
```

**Si tu rÃ©ponds NON Ã  une seule question â†’ NE COMMIT PAS**

---

## ğŸ§ª COMMENT TESTER

```bash
# Lancer les tests d'isolation tenant
npm run test:tenant

# VÃ©rifier le code avant commit
npm run lint:tenant
```

---

## ğŸ“ EN CAS DE DOUTE

1. **ARRÃŠTE** ce que tu fais
2. **LIS** ce document Ã  nouveau
3. **DEMANDE** si tu n'es pas sÃ»r
4. **NE COMMIT PAS** de code non sÃ©curisÃ©

---

## ğŸ¯ RAPPEL VISUEL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚   TENANT A          â”‚          TENANT B                 â”‚
â”‚   fatshairafro      â”‚          decoevent                â”‚
â”‚                     â”‚                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚   â”‚ Clients A â”‚     â”‚     â”‚ Clients B â”‚                 â”‚
â”‚   â”‚ RDV A     â”‚  ğŸ”’ â”‚  ğŸ”’ â”‚ RDV B     â”‚                 â”‚
â”‚   â”‚ Services Aâ”‚     â”‚     â”‚ Services Bâ”‚                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                     â”‚                                   â”‚
â”‚   â›” JAMAIS         â”‚     â›” JAMAIS                      â”‚
â”‚   d'accÃ¨s croisÃ©    â”‚     d'accÃ¨s croisÃ©                â”‚
â”‚                     â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš¡ LE SHIELD EN ACTION

Le systÃ¨me vÃ©rifie automatiquement :

1. **Pre-commit hook** - Bloque les commits dangereux
2. **Runtime middleware** - Valide chaque requÃªte
3. **Tests automatiques** - VÃ©rifie l'isolation
4. **Linter tenant** - Scanne le code

**Tu ne peux pas contourner le TENANT SHIELD.**

---

*DerniÃ¨re mise Ã  jour: 2026-02-21*
*Mainteneur: NEXUS Team*
