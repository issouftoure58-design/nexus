import{r as x,j as e}from"./index-_yXYEqcL.js";function M({data:s,color:l,height:t=32,width:c=120,filled:o=!1}){if(s.length<2)return null;const n=Math.max(...s,1),d=Math.min(...s,0),m=n-d||1,r=s.map((u,p)=>{const y=p/(s.length-1)*c,b=t-(u-d)/m*(t-4)-2;return`${y},${b}`});return e.jsxs("svg",{width:c,height:t,className:"opacity-80",children:[o&&e.jsx("polygon",{points:`0,${t} ${r.join(" ")} ${c},${t}`,fill:l,opacity:"0.15"}),e.jsx("polyline",{points:r.join(" "),fill:"none",stroke:l,strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"}),s.length>0&&e.jsx("circle",{cx:c,cy:parseFloat(r[r.length-1].split(",")[1]),r:"2.5",fill:l,className:"animate-pulse"})]})}function H({alive:s}){const[l,t]=x.useState(0);x.useEffect(()=>{if(!s)return;const d=setInterval(()=>t(m=>(m+1)%100),30);return()=>clearInterval(d)},[s]);const c=300,o=40,n=[];for(let d=0;d<c;d+=2){const m=d,r=(d+l*3)%c;let u=o/2;r>80&&r<85?u=o/2-4:r>85&&r<90?u=o/2+2:r>90&&r<95?u=o/2-18:r>95&&r<100?u=o/2+12:r>100&&r<105?u=o/2-3:r>105&&r<110&&(u=o/2+1),n.push(`${m},${u}`)}return e.jsx("svg",{width:c,height:o,className:"w-full",children:e.jsx("polyline",{points:n.join(" "),fill:"none",stroke:s?"#22d3ee":"#334155",strokeWidth:"2",strokeLinecap:"round",opacity:s?.9:.3})})}function D({value:s,max:l=100,label:t,unit:c="%",color:o,size:n=72}){const d=(n-10)/2,m=2*Math.PI*d,r=Math.min(s/l,1),u=m*(1-r),p=r>.8?"#ef4444":r>.6?"#eab308":o;return e.jsxs("div",{className:"flex flex-col items-center gap-1",children:[e.jsxs("svg",{width:n,height:n,className:"transform -rotate-90",children:[e.jsx("circle",{cx:n/2,cy:n/2,r:d,fill:"none",stroke:"#1e293b",strokeWidth:"5"}),e.jsx("circle",{cx:n/2,cy:n/2,r:d,fill:"none",stroke:p,strokeWidth:"5",strokeDasharray:m,strokeDashoffset:u,strokeLinecap:"round",className:"transition-all duration-700 ease-out"}),e.jsx("circle",{cx:n/2,cy:n/2,r:d,fill:"none",stroke:p,strokeWidth:"5",strokeDasharray:m,strokeDashoffset:u,strokeLinecap:"round",opacity:"0.3",filter:"blur(4px)"})]}),e.jsx("div",{className:"text-center -mt-[calc(50%+8px)] mb-4",children:e.jsxs("div",{className:"text-lg font-bold",style:{color:p},children:[s,e.jsx("span",{className:"text-xs opacity-60",children:c})]})}),e.jsx("div",{className:"text-[10px] text-slate-500 uppercase tracking-wider",children:t})]})}function P({value:s,max:l,color:t,label:c,detail:o}){const n=Math.min(s/l*100,100);return e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-[10px]",children:[e.jsx("span",{className:"text-slate-400",children:c}),e.jsx("span",{className:"text-slate-500",children:o})]}),e.jsx("div",{className:"h-2 bg-slate-800 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full rounded-full transition-all duration-700 ease-out relative",style:{width:`${n}%`,backgroundColor:t},children:e.jsx("div",{className:"absolute inset-0 rounded-full animate-pulse opacity-40",style:{backgroundColor:t}})})})]})}function B({active:s,label:l}){return e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${s?"bg-green-400":"bg-red-500"}`}),s&&e.jsx("div",{className:"absolute inset-0 w-2 h-2 rounded-full bg-green-400 animate-ping opacity-50"})]}),e.jsx("span",{className:`text-[10px] ${s?"text-green-400":"text-red-400"}`,children:l})]})}function O({insight:s}){const[l,t]=x.useState(!1),c={critical:{border:"border-red-700",bg:"bg-red-950/40",icon:"text-red-400",glow:"shadow-red-500/20 shadow-lg"},warn:{border:"border-yellow-700",bg:"bg-yellow-950/30",icon:"text-yellow-400",glow:""},info:{border:"border-blue-800",bg:"bg-blue-950/20",icon:"text-blue-400",glow:""},ok:{border:"border-green-800",bg:"bg-green-950/20",icon:"text-green-400",glow:""}},o=c[s.severity]||c.info,n={critical:"!!!",warn:"!",info:"i",ok:"OK"};return e.jsx("div",{className:`rounded-lg border ${o.border} ${o.bg} ${o.glow} p-3 cursor-pointer transition-all duration-300 hover:brightness-110`,onClick:()=>t(!l),children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:`${o.icon} font-mono font-bold text-xs mt-0.5 shrink-0 w-6 h-6 rounded-full border ${o.border} flex items-center justify-center ${s.severity==="critical"?"animate-pulse":""}`,children:n[s.severity]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:`text-sm font-semibold ${o.icon}`,children:s.title}),e.jsx("div",{className:"text-xs text-slate-400 mt-0.5 leading-relaxed",children:s.message}),l&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-slate-700/50",children:[e.jsx("div",{className:"text-[10px] text-slate-500 uppercase tracking-wider mb-1",children:"Recommandation Sentinel"}),e.jsx("div",{className:"text-xs text-cyan-300 leading-relaxed",children:s.recommendation})]}),!l&&e.jsx("div",{className:"text-[9px] text-slate-600 mt-1",children:"Cliquer pour voir la recommandation"})]})]})})}function W({text:s,severity:l}){const[t,c]=x.useState(""),[o,n]=x.useState(!1);x.useEffect(()=>{c(""),n(!1);let m=0;const r=setInterval(()=>{m++,m<=s.length?c(s.slice(0,m)):(n(!0),clearInterval(r))},15);return()=>clearInterval(r)},[s]);const d=l==="critical"?"text-red-400":l==="warn"?"text-yellow-300":l==="ok"?"text-green-400":"text-cyan-300";return e.jsxs("div",{className:`${d} text-xs font-mono leading-relaxed`,children:[t,!o&&e.jsx("span",{className:"animate-pulse",children:"|"})]})}function _(){const[s,l]=x.useState([]),[t,c]=x.useState(null),[o,n]=x.useState(""),[d,m]=x.useState(!1),[r,u]=x.useState(!1),[p,y]=x.useState([]),[b,N]=x.useState(-1),[j,L]=x.useState("insights"),w=x.useRef(null),E=x.useRef(null),I=x.useRef(null),v=x.useRef(null),A=x.useCallback(()=>{E.current?.scrollIntoView({behavior:"smooth"})},[]);x.useEffect(()=>{j==="console"&&A()},[s,A,j]);const $=x.useCallback(()=>{const a=window.location.protocol==="https:"?"wss:":"ws:",i=new WebSocket(`${a}//${window.location.host}/ws/sentinel`);return w.current=i,i.onopen=()=>{m(!0),v.current&&(clearTimeout(v.current),v.current=null)},i.onclose=()=>{m(!1),u(!1),w.current=null,v.current=setTimeout($,2e3)},i.onmessage=h=>{try{const f=JSON.parse(h.data);if(f.type==="heartbeat"){u(!0),setTimeout(()=>u(!1),200);return}if(f.type==="metric"){c(f.data);return}if(f.type==="welcome"){c(f.data.metrics),f.data.recentLogs&&l(f.data.recentLogs),l(C=>[...C,{type:"welcome",timestamp:f.timestamp,data:{message:f.data.message}}]);return}if(f.type==="command_result"&&f.data.command==="clear"){l([]);return}l(C=>[...C.slice(-400),f])}catch{}},i},[]);x.useEffect(()=>{const a=$();return()=>{v.current&&clearTimeout(v.current),a.close()}},[$]);const q=a=>{!a.trim()||!w.current||(y(i=>[...i.slice(-50),a]),N(-1),l(i=>[...i,{type:"log",timestamp:new Date().toISOString(),data:{level:"command",source:"CLI",message:`> ${a}`}}]),w.current.send(JSON.stringify({type:"command",command:a})),n(""))},U=a=>{if(a.key==="Enter")q(o);else if(a.key==="ArrowUp"){if(a.preventDefault(),p.length>0){const i=b<0?p.length-1:Math.max(0,b-1);N(i),n(p[i])}}else if(a.key==="ArrowDown"&&(a.preventDefault(),b>=0)){const i=b+1;i>=p.length?(N(-1),n("")):(N(i),n(p[i]))}},k=x.useMemo(()=>{if(!t)return"---";const a=t.uptime,i=Math.floor(a/3600),h=Math.floor(a%3600/60),f=a%60;return`${i}h ${h}m ${f}s`},[t?.uptime]),g=t?.insights||[],R=g.reduce((a,i)=>{const h={critical:3,warn:2,info:1,ok:0};return(h[i.severity]||0)>(h[a]||0)?i.severity:a},"ok"),T=x.useMemo(()=>{if(!t)return{text:"Connexion en cours...",severity:"info"};const a=g.filter(h=>h.severity==="critical"),i=g.filter(h=>h.severity==="warn");return a.length>0?{text:`ALERTE : ${a.map(h=>h.title).join(", ")}. ${a[0].recommendation}`,severity:"critical"}:i.length>0?{text:`Attention : ${i.map(h=>h.title).join(", ")}. ${i[0].recommendation}`,severity:"warn"}:t.uptime<120?{text:"Sentinel en ligne. Calibration des capteurs en cours... Les sparklines se rempliront dans quelques instants.",severity:"info"}:{text:`Tous les systemes fonctionnent normalement. CPU ${t.cpu}%, RAM Node ${t.memory.node.rss}MB. Uptime ${k}. Aucune anomalie detectee.`,severity:"ok"}},[t,g,k]),S=R==="critical"?"#ef4444":R==="warn"?"#eab308":"#22c55e";return e.jsxs("div",{className:"flex flex-col h-full gap-3 select-none",children:[e.jsxs("div",{className:"bg-slate-900/80 rounded-lg border border-slate-800 p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(B,{active:d,label:d?"LIVE":"OFFLINE"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:`w-2 h-2 rounded-full transition-all duration-200 ${r?"bg-cyan-400 shadow-[0_0_8px_#22d3ee]":"bg-slate-700"}`}),e.jsx("span",{className:"text-[10px] text-slate-500",children:"HEARTBEAT"})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-2 h-2 rounded-full transition-all",style:{backgroundColor:S,boxShadow:`0 0 6px ${S}`}}),e.jsx("span",{className:"text-[10px] text-slate-500",children:"HEALTH"})]})]}),e.jsxs("div",{className:"flex items-center gap-4 text-[10px] text-slate-500 font-mono",children:[e.jsxs("span",{children:["PID ",t?.pid||"---"]}),e.jsx("span",{children:t?.nodeVersion||""}),e.jsxs("span",{children:["UP ",k]})]})]}),e.jsxs("div",{className:"bg-black/40 rounded px-3 py-2 mb-2 min-h-[32px]",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full animate-pulse",style:{backgroundColor:S}}),e.jsx("span",{className:"text-[9px] text-slate-600 uppercase tracking-widest",children:"Sentinel Intelligence"})]}),e.jsx(W,{text:T.text,severity:T.severity})]}),e.jsx(H,{alive:d})]}),t?.env==="development"&&e.jsxs("div",{className:"bg-blue-950/30 border border-blue-800/50 rounded-lg px-3 py-2 text-[10px] text-blue-300",children:["Mode developpement â€” les metriques ci-dessous concernent votre Mac, pas un serveur distant. L'application NEXUS n'utilise que ",e.jsxs("span",{className:"text-white font-bold",children:[t?.memory.node.rss||0,"MB"]})," de memoire."]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-slate-900/80 rounded-lg border border-slate-800 p-3",children:[e.jsxs("div",{className:"text-[9px] text-slate-600 mb-1 uppercase tracking-wider",children:["Processeur ",t?.env==="development"?"(votre Mac)":"(serveur)"]}),e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx(D,{value:t?.cpu||0,label:"CPU",color:"#22d3ee"}),e.jsx("div",{className:"flex-1 ml-3",children:e.jsx(M,{data:t?.cpuHistory||[],color:"#22d3ee",filled:!0,width:140,height:50})})]})]}),e.jsxs("div",{className:"bg-slate-900/80 rounded-lg border border-slate-800 p-3",children:[e.jsx("div",{className:"text-[9px] text-slate-600 mb-1 uppercase tracking-wider",children:t?.memory.systemLabel||"RAM"}),e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx(D,{value:t?.memory.percent||0,label:"RAM",color:"#a78bfa"}),e.jsxs("div",{className:"flex-1 ml-3 space-y-2",children:[e.jsx(M,{data:t?.memory.history||[],color:"#a78bfa",filled:!0,width:140,height:28}),e.jsxs("div",{className:"text-[10px] text-slate-500 space-y-0.5",children:[e.jsxs("div",{children:["App NEXUS : ",e.jsxs("span",{className:"text-white font-medium",children:[t?.memory.node.rss||0,"MB"]})]}),e.jsxs("div",{children:["Heap JS : ",e.jsxs("span",{className:"text-slate-300",children:[t?.memory.node.heapUsed||0,"/",t?.memory.node.heapTotal||0,"MB"]})]})]})]})]})]}),e.jsxs("div",{className:"bg-slate-900/80 rounded-lg border border-slate-800 p-3",children:[e.jsx("div",{className:"text-[9px] text-slate-600 mb-1 uppercase tracking-wider",children:"Requetes API (depuis le demarrage)"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-emerald-400",children:t?.requests.total||0}),e.jsxs("div",{className:"text-[10px] text-slate-500",children:["depuis ",k]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-lg font-bold text-emerald-300",children:[t?.requests.perMinute||0,e.jsx("span",{className:"text-xs text-slate-500",children:"/min"})]}),(t?.requests.errors||0)>0&&e.jsxs("div",{className:"text-xs text-red-400",children:[t?.requests.errors," erreur",(t?.requests.errors||0)>1?"s":""]})]})]}),e.jsx(M,{data:t?.requests.history||[],color:"#34d399",filled:!0,width:200,height:30}),e.jsx(P,{value:t?.memory.node.heapUsed||0,max:t?.memory.node.heapTotal||256,color:"#a78bfa",label:"Memoire app NEXUS",detail:`${t?.memory.node.heapUsed||0}/${t?.memory.node.heapTotal||0}MB`})]})]})]}),e.jsxs("div",{className:"flex gap-1 text-xs",children:[e.jsxs("button",{onClick:()=>L("insights"),className:`px-3 py-1.5 rounded-t-lg transition ${j==="insights"?"bg-slate-900 text-cyan-400 border border-b-0 border-slate-800":"text-slate-500 hover:text-slate-300"}`,children:["Diagnostics (",g.length,")"]}),e.jsxs("button",{onClick:()=>L("console"),className:`px-3 py-1.5 rounded-t-lg transition ${j==="console"?"bg-black/90 text-green-400 border border-b-0 border-slate-800":"text-slate-500 hover:text-slate-300"}`,children:["Console (",s.length,")"]})]}),j==="insights"&&e.jsx("div",{className:"flex-1 bg-slate-900/80 rounded-lg rounded-tl-none border border-slate-800 p-3 overflow-y-auto min-h-[200px] space-y-2",children:g.length===0?e.jsx("div",{className:"text-slate-500 text-sm py-8 text-center",children:"Sentinel analyse les metriques... Les diagnostics apparaitront dans quelques secondes."}):g.map(a=>e.jsx(O,{insight:a},a.id))}),j==="console"&&e.jsxs("div",{className:"flex-1 bg-black/90 rounded-lg rounded-tl-none border border-slate-800 font-mono text-[11px] overflow-hidden flex flex-col min-h-[200px]",onClick:()=>I.current?.focus(),children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-3 space-y-px min-h-0",children:[s.map((a,i)=>e.jsx(F,{entry:a},i)),e.jsx("div",{ref:E})]}),e.jsxs("div",{className:"border-t border-slate-800/50 px-3 py-2 flex items-center gap-2 bg-slate-950/80",children:[e.jsx("span",{className:"text-cyan-500 font-bold",children:"sentinel >"}),e.jsx("input",{ref:I,type:"text",value:o,onChange:a=>n(a.target.value),onKeyDown:U,autoComplete:"off","data-lpignore":"true","data-1p-ignore":"true","aria-autocomplete":"none",className:"flex-1 bg-transparent text-green-400 outline-none caret-green-400 placeholder:text-slate-700",placeholder:"help | status | health | rdv | tenants | logs",autoFocus:!0}),d&&e.jsx("div",{className:"w-1.5 h-4 bg-green-500 rounded-sm animate-pulse"})]})]})]})}function F({entry:s}){const l=new Date(s.timestamp).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit",second:"2-digit"});if(s.type==="welcome")return e.jsxs("div",{className:"text-cyan-400 py-1 border-b border-slate-800/30 mb-1",children:[e.jsxs("span",{className:"text-slate-600",children:["[",l,"]"]})," ",s.data.message]});if(s.type==="command_result"){const{result:r,command:u}=s.data;return u==="clear"?null:Array.isArray(r)?e.jsx("div",{className:"text-slate-300 py-0.5",children:r.map((p,y)=>e.jsx("div",{className:"pl-4",children:typeof p=="string"?p:JSON.stringify(p)},y))}):typeof r=="string"?e.jsx("div",{className:"text-yellow-300 pl-4 py-0.5",children:r}):e.jsx("div",{className:"text-slate-300 pl-4 py-0.5",children:e.jsx("pre",{className:"whitespace-pre-wrap",children:JSON.stringify(r,null,2)})})}const{level:t,source:c,message:o,details:n}=s.data||{},d={info:{text:"text-slate-400",badge:"text-blue-400"},warn:{text:"text-yellow-300",badge:"text-yellow-500"},error:{text:"text-red-400",badge:"text-red-500"},success:{text:"text-green-400",badge:"text-green-500"},command:{text:"text-cyan-300",badge:"text-cyan-500"}},m=d[t]||d.info;return e.jsxs("div",{className:`${m.text} flex items-baseline gap-1 py-px hover:bg-slate-900/30`,children:[e.jsxs("span",{className:"text-slate-700 shrink-0",children:["[",l,"]"]}),c&&e.jsxs("span",{className:`${m.badge} text-[9px] font-bold shrink-0`,children:["[",c,"]"]}),e.jsx("span",{className:"truncate",children:o}),n?.status&&e.jsx("span",{className:`text-[9px] ml-auto shrink-0 px-1 rounded ${n.status>=500?"bg-red-900/40 text-red-400":n.status>=400?"bg-yellow-900/40 text-yellow-400":"bg-green-900/40 text-green-400"}`,children:n.status}),n?.duration!=null&&e.jsxs("span",{className:`text-[9px] shrink-0 ${n.duration>1e3?"text-red-400":n.duration>200?"text-yellow-400":"text-slate-600"}`,children:[n.duration,"ms"]}),n?.recommendation&&e.jsx("span",{className:"text-[9px] text-cyan-600 shrink-0 ml-1",title:n.recommendation,children:"TIP"})]})}export{_ as default};
